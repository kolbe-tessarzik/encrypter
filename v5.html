<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<title>Competition Compressor — High Density (pako + tokenization + bitpack)</title>
<style>
  body{background:#071026;color:#e6eef6;font-family:system-ui,monospace;padding:20px}
  h1{margin:0 0 6px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  textarea,input{width:100%;padding:10px;border-radius:8px;border:1px solid #2a3b4f;background:#0b1a2b;color:#e6eef6;resize:vertical}
  label{font-size:13px;color:#9fb0c3}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .stats{margin-top:8px;color:#9fe9c7}
  button{padding:8px 12px;border-radius:8px;border:0;background:#2dd4bf;color:#042;font-weight:700;cursor:pointer}
  .small{font-size:13px;color:#9fb0c3}
  .muted{color:#86a0b6;font-size:13px}
  #loading { color:#ffd86b }
</style>

<body>
  <h1>Competition Compressor — High Density</h1>
  <div class="muted">Dictionary → pako.deflate → XOR (optional) → keyed bit-packing → compact Unicode output</div>

  <div style="margin-top:12px">
    <label>Key (optional — toggles keyed alphabet)</label>
    <input id="key" placeholder="passphrase (optional)">
  </div>

  <div style="height:12px;"></div>
  <div class="grid">
    <div>
      <label>Input (original)</label>
      <textarea id="input" placeholder="Paste original text here..." rows="18"></textarea>
      <div class="row">
        <button id="encodeBtn">Encode →</button>
        <div class="small muted">Auto encodes as you type</div>
      </div>
    </div>

    <div>
      <label>Output (compact)</label>
      <textarea id="output" placeholder="Compressed output appears here..." rows="18"></textarea>
      <div class="row">
        <button id="decodeBtn">Decode ←</button>
        <div class="small muted">Auto decodes when you edit output</div>
      </div>
    </div>
  </div>

  <div class="stats" id="stats">Initializing... <span id="loading">building alphabet — one moment</span></div>

  <!-- pako for compression -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script> -->

  <script src="v5.js" id="impl" type="module" defer></script>
  <script>
  // ----------------- UI wiring -----------------
  const inputEl = document.getElementById("input");
  const outputEl = document.getElementById("output");
  const keyEl = document.getElementById("key");
  const statsEl = document.getElementById("stats");
  const loadingSpan = document.getElementById("loading");
  const encBtn = document.getElementById("encodeBtn");
  const decBtn = document.getElementById("decodeBtn");

  // Build the charset (async to avoid blocking UI)
  window.addEventListener("load", async () => {
    loadingSpan.textContent = "building alphabet — this can take 1–3s depending on CPU";
    await new Promise(r => setTimeout(r, 50)); // let DOM update
    loadingSpan.textContent = "alphabet ready";
    initDone = true;
    setTimeout(() => loadingSpan.remove(), 900);
    // try initial conversion if input exists
    if (inputEl.value) debouncedEncode();
  });


  let suppress = false;
  let initDone = false;

  // debounce helpers
  function debounce(fn, ms = 220) {
    let t;
    return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
  }

  async function doEncodeUI() {
    if (!initDone) { statsEl.textContent = "Still initializing alphabet — wait a moment."; return; }
    if (suppress) return;
    suppress = true;
    try {
      statsEl.textContent = "Encoding...";
      const key = keyEl.value || "";
      const out = "䀦" + (await window.encrypt(inputEl.value, key));
      outputEl.value = out;
      const o = inputEl.value.length;
      const e = out.length;
      const pct = o ? Math.round((1 - (e / o)) * 100) : 0;
      statsEl.textContent = `Original ${o} chars → Encoded ${e} chars · approx ${pct}% smaller`;
    } catch (err) {
      statsEl.textContent = "Encode error: " + (err && err.message ? err.message : String(err));
    } finally { suppress = false; }
  }

  async function doDecodeUI() {
    if (!initDone) { statsEl.textContent = "Still initializing alphabet — wait a moment."; return; }
    if (suppress) return;
    suppress = true;
    try {
      statsEl.textContent = "Decoding...";
      const key = keyEl.value || "";
      const out = (await window.decrypt(outputEl.value.slice(1), key));
      inputEl.value = out;
      statsEl.textContent = `Decoded length: ${out.length} chars`;
    } catch (err) {
      statsEl.textContent = "Decode error: " + (err && err.message ? err.message : String(err));
    } finally { suppress = false; }
  }

  const debouncedEncode = debounce(doEncodeUI, 260);
  const debouncedDecode = debounce(doDecodeUI, 260);


document.getElementById("impl").onload = () => {
  inputEl.addEventListener("input", debouncedEncode);
  outputEl.addEventListener("input", debouncedDecode);
  keyEl.addEventListener("input", () => { debouncedEncode(); debouncedDecode(); });
  encBtn.addEventListener("click", doEncodeUI);
  decBtn.addEventListener("click", doDecodeUI);
}
  </script>
</body>
</html>
